(()=>{"use strict";const e=document.getElementById("status"),a=document.getElementById("selectFolderBtn");function t(a,t){e.textContent=a,e.className=t}!async function(){const e=new URLSearchParams(window.location.search).get("id");if(!e)return t("Error: No data ID provided.","error"),void(a.disabled=!0);const o=(await chrome.storage.local.get(e))[e];if(!o)return t("Error: Data not found or expired.","error"),void(a.disabled=!0);console.log("Data loaded",o),console.log("Images info:",o.images),t(`Ready to save "${o.title}" (${o.images.length} images).`,"normal"),a.onclick=async()=>{try{a.disabled=!0,t("Selecting folder...","normal");const r=await window.showDirectoryPicker();t("Writing files...","normal");const i=o.title.replace(/[<>:"/\\|?*]/g,"_").trim(),c=await r.getFileHandle(`${i}.org`,{create:!0}),s=await c.createWritable();if(await s.write(o.content),await s.close(),o.images.length>0){const e=await r.getDirectoryHandle("images",{create:!0});for(const a of o.images)try{const t=await e.getFileHandle(a.filename,{create:!0}),o=await t.createWritable(),r=await fetch(a.base64),i=await r.blob();await o.write(i),await o.close()}catch(e){console.error("Failed to save image",a.filename,e)}}t("Saved successfully! You can close this tab.","success"),chrome.storage.local.remove(e),setTimeout((()=>{window.close()}),3e3)}catch(e){console.error(e),"AbortError"===e.name?t("Cancelled by user.","normal"):t("Error: "+e.message,"error"),a.disabled=!1}}}()})();