/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";class e{static sendToTab(e,t){return chrome.tabs.sendMessage(e,t)}static sendToBg(e){return chrome.runtime.sendMessage(e)}}var t;!function(e){e[e.inPagePopup=0]="inPagePopup",e[e.notificationApi=1]="notificationApi",e[e.none=2]="none"}(t||(t={}));const o=function(e){const t=[];for(const o in e)o.match(/^\d+$/)||t.push(o);return t}(t);function r(e,t){return Object.assign({},e,t)}function n(e){return JSON.parse(JSON.stringify(e))}const a=new class{constructor(){chrome.storage.sync?this.area=chrome.storage.sync:this.area=chrome.storage.local}getDefaultData(){return{apiLevel:1,listIndentSize:2,ulBulletChar:"-",olBulletChar:".",codeChar:"=",rubyHandleMethod:"removeRuby",codeBlockStyle:"beginEnd",escapeHtmlEntities:!1,squareBracketsInLink:"replaceWithRoundBrackets",insertReferenceLink:{enabled:!1,pos:"append",format:"-----\nOriginal Reference: [[%url%][%title%]]\n(Retrieved at [%datetime%])\n"},titleBlackList:"",convertImageAsDataUrl:!1,notificationMethod:"inPagePopup",decodeUri:!0,autoConvertPageUrl:!1,saveImages:!0,imagePathPrefix:"",imageSaveSubfolder:"images"}}setDataPartially(e){console.log("[SET] TO STORAGE",n(e)),this.area.set(n(e))}getData(){return this.area.get().then((e=>{let t=!1;const r=e;console.log("[GET] ORIGINAL",n(r));const a=this.getDefaultData();if(!r)return this.setDataPartially(a),a;const i=this.getDefaultData();for(const e in i){const o=e;void 0!==r[o]?i[o]=r[o]:t=!0}var c,s;void 0===r.apiLevel&&(i.notificationMethod=(c=i.notificationMethod,(s=o).includes(c)?c:s[0]),i.insertReferenceLink.format=a.insertReferenceLink.format,i.apiLevel=1);e:for(;i.apiLevel!==a.apiLevel;)switch(i.apiLevel){case void 0:i.apiLevel=1;continue e;case 1:break;default:i.apiLevel}return console.log("[GET] FIXED",i),t&&this.setDataPartially(i),i})).catch((e=>(console.error("Error when getting settings from browser.storage:",e),this.getDefaultData())))}onDataChanged(e){chrome.storage.onChanged.addListener(((t,o)=>{"sync"!==o&&"local"!==o||e(t)}))}},i=a.getDefaultData();function c(e,t){let o=e.substr(0,t);return e.length>t&&(o+="..."),o}function s(t,o){console.log("showBgNotification(), method =",i.notificationMethod,Date.now(),t,o),"inPagePopup"!==i.notificationMethod?"notificationApi"===i.notificationMethod&&(console.log("showBgNotification..."),chrome.notifications.create("default",{title:t,type:"basic",iconUrl:chrome.runtime.getURL("img/icon.png"),message:c(o,80)},(e=>{setTimeout((()=>{chrome.notifications.clear(e)}),800)})),console.log("showBgNotification finished.")):(t.replace(/[\n\r<>\\]/gi,"").replace(/["'`]/gi,"'"),o.replace(/[\n\r<>\\]/gi,"").replace(/["'`]/gi,"'"),chrome.tabs.query({active:!0,currentWindow:!0}).then((r=>{for(const n of r){if(void 0===n.id)return;e.sendToTab(n.id,{type:"showInPageNotification",title:t,message:c(o,100),duration:800})}})))}async function l(e,t){if(console.log("bgCopyToClipboard() start",Date.now(),"text ===",e),!e)return console.warn("text is empty, skip.",e),s("Oops...","Got nothing to copy..."),!1;try{console.log("Getting active tab...");const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t.id)throw new Error("No active tab found");console.log("Active tab found:",t.id),console.log("Executing copy script...");const o=await chrome.scripting.executeScript({target:{tabId:t.id},func:e=>new Promise((t=>{console.log("Creating textarea...");const o=document.createElement("textarea");o.style.position="fixed",o.style.left="-9999px",o.value=e,document.body.appendChild(o);try{console.log("Selecting text..."),o.select(),console.log("Executing copy command...");const e=document.execCommand("copy");console.log("Copy command result:",e),t(e)}catch(e){console.error("Copy failed:",e),t(!1)}finally{document.body.removeChild(o)}})),args:[e]});if(console.log("Script execution results:",o),o&&o[0]&&!0===o[0].result)return console.log("Copy successful, showing notification..."),s("Org-Mode Text Copied Successfully!",e),!0;throw new Error("Copy operation failed")}catch(e){return console.error("Failed to copy text:",e),s("Copy Failed","Failed to copy text to clipboard"),!1}}console.log("[background] first time to get config from storage"),a.getData().then((e=>{r(i,e)})),a.onDataChanged((async e=>{console.log("[background] storage changed!",e),r(i,await a.getData())})),chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.removeAll((()=>{chrome.contextMenus.create({id:"save-page-as-org",title:"Save Page as Org-Mode",contexts:["page","frame"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"save-page-as-org-folder",title:"Save Page as Org-Mode (With Images)",contexts:["page","frame"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"copy-link-as-org-mode",title:"Copy Link as Org-Mode",contexts:["link"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"copy-selection-as-org-mode",title:"Copy Selection as Org-Mode",contexts:["selection"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"copy-current-page-url-as-org-mode",title:"Copy Page as Org-Mode Link",contexts:["page"],documentUrlPatterns:["<all_urls>"]})}))})),Date.now(),chrome.contextMenus.onClicked.addListener((async(e,t)=>{if(!t?.id)return;const o=t.id;if(await async function(e){try{const t=(await chrome.tabs.get(e)).url||"";return t.startsWith("http")||t.startsWith("https")}catch(e){return console.error("Error checking tab:",e),!1}}(o)){if("save-page-as-org"===e.menuItemId)try{await async function(e){try{console.log("[savePageAsOrg] Injecting scripts..."),await chrome.scripting.executeScript({target:{tabId:e},files:["dist/defuddle.js","dist/content-script.js"]}),console.log("[savePageAsOrg] Scripts injected.");const t=await chrome.scripting.executeScript({target:{tabId:e},func:e=>{try{console.log("[content-script] Starting conversion...");let t="",o=document.title,r=document.querySelector('meta[name="author"]')?.getAttribute("content")||"",n=document.querySelector('meta[name="description"]')?.getAttribute("content")||"",a="",i=window.location.hostname,c="",s=document.querySelector('meta[name="keywords"]')?.getAttribute("content")||"";if(window.Defuddle){console.log("[content-script] Defuddle found, attempting parse...");try{const e=new window.Defuddle(document).parse();if(e){if(console.log("[content-script] Defuddle success:",e),e.content&&(t=e.content),e.title&&(o=e.title),e.author&&(r=e.author),e.description&&(n=e.description),e.site&&(a=e.site),e.domain&&(i=e.domain),e.published&&(c=e.published),e.metaTags){const t=e.metaTags,o=t.keywords||t.news_keywords||t.tags;o&&(s=Array.isArray(o)?o.join(","):o)}}else console.warn("[content-script] Defuddle returned null article")}catch(e){e instanceof Error?e.message:String(e),console.error("[content-script] Defuddle failed:",e)}}else console.warn("[content-script] window.Defuddle is undefined!");t||(console.log("[content-script] Fallback to simple extraction"),t=(document.querySelector("article")||document.body).innerHTML);const l=document.createElement("div");l.innerHTML=t;const d=o.trim().toLowerCase();let g=0;for(;l.firstElementChild&&g<3;){const e=l.firstElementChild;if(/^H[1-6]$/.test(e.tagName)||"DIV"===e.tagName||"P"===e.tagName||"HEADER"===e.tagName){const t=e.textContent?.trim().toLowerCase()||"";if(t.length>5&&(d.includes(t)||t.includes(d))){e.remove(),g++;continue}}break}const u={...e,saveImages:!1,extractedImages:void 0};let m="";try{console.log("[content-script] Converting to Org..."),m=window.html2org.convert(l.innerHTML,u),console.log("[content-script] Conversion success.")}catch(e){console.error("[content-script] Conversion failed:",e),console.log("[content-script] Retrying with raw body content...");const t=document.querySelector("article")||document.body;l.innerHTML=t.innerHTML,m=window.html2org.convert(l.innerHTML,u)}return{title:o,content:m,extractedImages:[],url:document.URL,author:r,description:n,site:a,domain:i,published:c,keywords:s}}catch(e){return console.error("Error in content script:",e),null}},args:[{unorderedListMarker:i.ulBulletChar,orderedListMarker:i.olBulletChar,codeDelimiter:i.codeChar,listIndentSize:i.listIndentSize,codeBlockStyle:i.codeBlockStyle,decodeUri:i.decodeUri,squareBracketsInLink:i.squareBracketsInLink,ruby:i.rubyHandleMethod,saveImages:!1,imagePathPrefix:i.imagePathPrefix,imageSaveSubfolder:i.imageSaveSubfolder,extractedImages:[]}]});if(!t?.[0]?.result)throw new Error("Failed to get page content");const{title:o,content:r,url:n,author:a,description:c,site:s,domain:l,published:d,keywords:g,extractedImages:u}=t[0].result;let m=`#+TITLE: ${o}\n`;m+=`#+DATE: ${(new Date).toISOString()}\n`,a&&(m+=`#+AUTHOR: ${a}\n`),m+=`#+SOURCE_URL: ${n}\n`;let p=[];g&&(p=g.split(/,\s*/).filter((e=>e.trim())),p.length>0&&(m+=`#+KEYWORDS: ${p.join(", ")}\n`)),m+=`\n${r}`;const h="data:text/org;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(m))),f=e=>e.replace(/[<>:"/\\|?*#\x00-\x1F]/g,"").replace(/\s+/g," ").trim(),y=e=>f(e).replace(/__/g," ").replace(/==/g," ").trim(),w=y(o),b=a?y(a):"",k=p.map(y).slice(0,5).join("_");let v="";b&&(v+=`${b}__`),v+=w,k&&(v+=`==${k}`),v+=".org",".org"===v&&(v="captured_content.org"),await chrome.downloads.download({url:h,filename:v,saveAs:!0})}catch(e){console.error("Failed to save page:",e),s("Error",`Failed to save page: ${e instanceof Error?e.message:"Unknown error"}`)}}(o)}catch(e){console.error("Failed to execute script:",e),s("Error",`Failed to process page content: ${e instanceof Error?e.message:"Unknown error"}`)}else if("save-page-as-org-folder"===e.menuItemId)try{await async function(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:["dist/defuddle.js","dist/content-script.js"]});const t=await chrome.scripting.executeScript({target:{tabId:e},func:e=>{try{let t="",o=document.title,r=document.querySelector('meta[name="author"]')?.getAttribute("content")||"",n=document.querySelector('meta[name="description"]')?.getAttribute("content")||"",a="",i=window.location.hostname,c="",s=document.querySelector('meta[name="keywords"]')?.getAttribute("content")||"";if(window.Defuddle){console.log("[content-script] Defuddle found, attempting parse...");try{const e=new window.Defuddle(document).parse();if(e){if(console.log("[content-script] Defuddle success:",e),e.content&&(t=e.content),e.title&&(o=e.title),e.author&&(r=e.author),e.description&&(n=e.description),e.site&&(a=e.site),e.domain&&(i=e.domain),e.published&&(c=e.published),e.metaTags){const t=e.metaTags,o=t.keywords||t.news_keywords||t.tags;o&&(s=Array.isArray(o)?o.join(","):o)}}else console.warn("[content-script] Defuddle returned null article")}catch(e){e instanceof Error?e.message:String(e),console.error("[content-script] Defuddle failed:",e)}}t||(t=(document.querySelector("article")||document.body).innerHTML);const l=document.createElement("div");l.innerHTML=t;const d=o.trim().toLowerCase();let g=0;for(;l.firstElementChild&&g<3;){const e=l.firstElementChild;if(/^H[1-6]$/.test(e.tagName)||"DIV"===e.tagName||"P"===e.tagName||"HEADER"===e.tagName){const t=e.textContent?.trim().toLowerCase()||"";if(t.length>5&&(d.includes(t)||t.includes(d))){e.remove(),g++;continue}}break}const u={...e,extractedImages:[]};let m="";try{m=window.html2org.convert(l.innerHTML,u)}catch(e){console.error("[content-script] Conversion failed:",e);const t=document.querySelector("article")||document.body;l.innerHTML=t.innerHTML,m=window.html2org.convert(l.innerHTML,u)}return{title:o,content:m,extractedImages:u.extractedImages||[],url:document.URL,author:r,description:n,site:a,domain:i,published:c,keywords:s}}catch(e){return console.error("Error in content script:",e),null}},args:[{unorderedListMarker:i.ulBulletChar,orderedListMarker:i.olBulletChar,codeDelimiter:i.codeChar,listIndentSize:i.listIndentSize,codeBlockStyle:i.codeBlockStyle,decodeUri:i.decodeUri,squareBracketsInLink:i.squareBracketsInLink,ruby:i.rubyHandleMethod,saveImages:!0,imagePathPrefix:i.imagePathPrefix}]});if(!t?.[0]?.result)throw new Error("Failed to get page content");const o=t[0].result;console.log("[savePageAsOrgFolder] Extracted images:",o.extractedImages);const r=o.extractedImages.map((e=>{try{return new URL(e.src,o.url).href}catch(t){return e.src}}));let n=[];if(r.length>0)try{const t=await chrome.scripting.executeScript({target:{tabId:e},func:async e=>window.html2org.fetchImagesAsBase64?await window.html2org.fetchImagesAsBase64(e):[],args:[r]});if(t?.[0]?.result){const e=t[0].result;console.log("[savePageAsOrgFolder] Fetched image data:",e),n=o.extractedImages.map(((t,o)=>({filename:t.filename,base64:e[o]?.base64||""}))).filter((e=>e.base64)),console.log("[savePageAsOrgFolder] Final image data with correct filenames:",n)}}catch(e){console.error("Failed to fetch images",e),s("Warning","Failed to download images. Saving text only."),n=[]}let a=`#+TITLE: ${o.title}\n`;a+=`#+DATE: ${(new Date).toISOString()}\n`,o.author&&(a+=`#+AUTHOR: ${o.author}\n`),a+=`#+SOURCE_URL: ${o.url}\n`;let c=[];o.keywords&&(c=o.keywords.split(/,\s*/).filter((e=>e.trim())),c.length>0&&(a+=`#+KEYWORDS: ${c.join(", ")}\n`)),a+=`\n${o.content}`;const l=e=>e.replace(/[<>:"/\\|?*#\x00-\x1F]/g,"").replace(/\s+/g," ").trim(),d=e=>l(e).replace(/__/g," ").replace(/==/g," ").trim(),g=d(o.title),u=o.author?d(o.author):"",m=c.map(d).slice(0,5).join("_");let p="";u&&(p+=`${u}__`),p+=g,m&&(p+=`==${m}`),p+=".org",".org"===p&&(p="captured_content.org");const h=`save_folder_${Date.now()}`,f={title:o.title,filename:p,content:a,images:n};try{await chrome.storage.local.set({[h]:f}),chrome.tabs.create({url:`dist/save_folder.html?id=${h}`})}catch(e){console.error("Storage set failed",e),s("Error",`Failed to prepare data (likely too large): ${e.message}`)}}catch(e){console.error("Failed to save page:",e),s("Error",`Failed to save page: ${e instanceof Error?e.message:"Unknown error"}`)}}(o)}catch(e){console.error("Failed to execute script:",e),s("Error",`Failed to process page content: ${e instanceof Error?e.message:"Unknown error"}`)}else if("copy-current-page-url-as-org-mode"===e.menuItemId)try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.url||!e.title)throw new Error("Cannot get page information");const t=`[[${e.url}][${e.title}]]`;await l(t,(e.url,e.title))}catch(e){console.error("Failed to copy page link:",e),s("Error",`Failed to copy page link: ${e instanceof Error?e.message:"Unknown error"}`)}else if("copy-selection-as-org-mode"===e.menuItemId)try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["dist/copy.js"]}),await chrome.scripting.executeScript({target:{tabId:t.id},func:()=>window.main()})}catch(e){console.error("Failed to copy selection:",e),s("Error",`Failed to copy selection: ${e instanceof Error?e.message:"Unknown error"}`)}else if("copy-link-as-org-mode"===e.menuItemId)try{await chrome.scripting.executeScript({target:{tabId:o},files:["dist/copy-link.js"]});const t=e;if(!t.linkText||!t.linkUrl)throw new TypeError("Missing link information");const r=t.linkText.replace(/([\\`*_[\]<>])/g,"\\$1");let n=t.linkUrl;console.log("Options ===>",i),i.decodeUri&&(n=function(e){try{return decodeURI(e)}catch(t){return console.error("[ERROR] decodeURI error",t),e}}(n)),l(`[[${n}][${r}]]`)}catch(e){console.error("Failed to process link:",e),s("Error",`Failed to copy link: ${e instanceof Error?e.message:"Unknown error"}`)}}else s("Error","Cannot execute script on this page")})),chrome.action.onClicked.addListener((e=>{console.log("[DEBUG] browserAction.onclicked",e),chrome.scripting.executeScript({target:{tabId:e.id??-1},files:["dist/copy.js"]})})),chrome.runtime.onMessage.addListener(((e,t,o)=>{const r=e;switch(r.type){case"showBgNotification":s(r.title,r.message);break;case"copyStringToClipboard":return console.log("listener: copy request",Date.now()),l(r.org,r.html).then((e=>{o({success:e})})),!0}}))})();