/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";class e{static sendToTab(e,t){return chrome.tabs.sendMessage(e,t)}static sendToBg(e){return chrome.runtime.sendMessage(e)}}var t;!function(e){e[e.inPagePopup=0]="inPagePopup",e[e.notificationApi=1]="notificationApi",e[e.none=2]="none"}(t||(t={}));const o=function(e){const t=[];for(const o in e)o.match(/^\d+$/)||t.push(o);return t}(t);function r(e,t){return Object.assign({},e,t)}function n(e){return JSON.parse(JSON.stringify(e))}const a=new class{constructor(){chrome.storage.sync?this.area=chrome.storage.sync:this.area=chrome.storage.local}getDefaultData(){return{apiLevel:1,listIndentSize:2,ulBulletChar:"-",olBulletChar:".",codeChar:"=",rubyHandleMethod:"removeRuby",codeBlockStyle:"beginEnd",escapeHtmlEntities:!1,squareBracketsInLink:"replaceWithRoundBrackets",insertReferenceLink:{enabled:!1,pos:"append",format:"-----\nOriginal Reference: [[%url%][%title%]]\n(Retrieved at [%datetime%])\n"},titleBlackList:"",convertImageAsDataUrl:!1,notificationMethod:"inPagePopup",decodeUri:!0,autoConvertPageUrl:!1,saveImages:!0,imagePathPrefix:"",imageSaveSubfolder:"images"}}setDataPartially(e){console.log("[SET] TO STORAGE",n(e)),this.area.set(n(e))}getData(){return this.area.get().then((e=>{let t=!1;const r=e;console.log("[GET] ORIGINAL",n(r));const a=this.getDefaultData();if(!r)return this.setDataPartially(a),a;const c=this.getDefaultData();for(const e in c){const o=e;void 0!==r[o]?c[o]=r[o]:t=!0}var i,s;void 0===r.apiLevel&&(c.notificationMethod=(i=c.notificationMethod,(s=o).includes(i)?i:s[0]),c.insertReferenceLink.format=a.insertReferenceLink.format,c.apiLevel=1);e:for(;c.apiLevel!==a.apiLevel;)switch(c.apiLevel){case void 0:c.apiLevel=1;continue e;case 1:break;default:c.apiLevel}return console.log("[GET] FIXED",c),t&&this.setDataPartially(c),c})).catch((e=>(console.error("Error when getting settings from browser.storage:",e),this.getDefaultData())))}onDataChanged(e){chrome.storage.onChanged.addListener(((t,o)=>{"sync"!==o&&"local"!==o||e(t)}))}},c=a.getDefaultData();function i(e,t){let o=e.substr(0,t);return e.length>t&&(o+="..."),o}function s(t,o){console.log("showBgNotification(), method =",c.notificationMethod,Date.now(),t,o),"inPagePopup"!==c.notificationMethod?"notificationApi"===c.notificationMethod&&(console.log("showBgNotification..."),chrome.notifications.create("default",{title:t,type:"basic",iconUrl:chrome.runtime.getURL("img/icon.png"),message:i(o,80)},(e=>{setTimeout((()=>{chrome.notifications.clear(e)}),800)})),console.log("showBgNotification finished.")):(t.replace(/[\n\r<>\\]/gi,"").replace(/["'`]/gi,"'"),o.replace(/[\n\r<>\\]/gi,"").replace(/["'`]/gi,"'"),chrome.tabs.query({active:!0,currentWindow:!0}).then((r=>{for(const n of r){if(void 0===n.id)return;e.sendToTab(n.id,{type:"showInPageNotification",title:t,message:i(o,100),duration:800})}})))}async function l(e,t){if(console.log("bgCopyToClipboard() start",Date.now(),"text ===",e),!e)return console.warn("text is empty, skip.",e),s("Oops...","Got nothing to copy..."),!1;try{console.log("Getting active tab...");const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t.id)throw new Error("No active tab found");console.log("Active tab found:",t.id),console.log("Executing copy script...");const o=await chrome.scripting.executeScript({target:{tabId:t.id},func:e=>new Promise((t=>{console.log("Creating textarea...");const o=document.createElement("textarea");o.style.position="fixed",o.style.left="-9999px",o.value=e,document.body.appendChild(o);try{console.log("Selecting text..."),o.select(),console.log("Executing copy command...");const e=document.execCommand("copy");console.log("Copy command result:",e),t(e)}catch(e){console.error("Copy failed:",e),t(!1)}finally{document.body.removeChild(o)}})),args:[e]});if(console.log("Script execution results:",o),o&&o[0]&&!0===o[0].result)return console.log("Copy successful, showing notification..."),s("Org-Mode Text Copied Successfully!",e),!0;throw new Error("Copy operation failed")}catch(e){return console.error("Failed to copy text:",e),s("Copy Failed","Failed to copy text to clipboard"),!1}}console.log("[background] first time to get config from storage"),a.getData().then((e=>{r(c,e)})),a.onDataChanged((async e=>{console.log("[background] storage changed!",e),r(c,await a.getData())})),chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.removeAll((()=>{chrome.contextMenus.create({id:"save-page-as-org",title:"Save Page as Org-Mode",contexts:["page","frame"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"save-page-as-org-folder",title:"Save Page as Org-Mode (With Images)",contexts:["page","frame"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"copy-link-as-org-mode",title:"Copy Link as Org-Mode",contexts:["link"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"copy-selection-as-org-mode",title:"Copy Selection as Org-Mode",contexts:["selection"],documentUrlPatterns:["<all_urls>"]}),chrome.contextMenus.create({id:"copy-current-page-url-as-org-mode",title:"Copy Page as Org-Mode Link",contexts:["page"],documentUrlPatterns:["<all_urls>"]})}))})),Date.now(),chrome.contextMenus.onClicked.addListener((async(e,t)=>{if(!t?.id)return;const o=t.id;if(await async function(e){try{const t=(await chrome.tabs.get(e)).url||"";return t.startsWith("http")||t.startsWith("https")}catch(e){return console.error("Error checking tab:",e),!1}}(o)){if("save-page-as-org"===e.menuItemId)try{await async function(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:["dist/content-script.js"]});const t=await chrome.scripting.executeScript({target:{tabId:e},func:e=>{try{const t=(document.querySelector("article")||document.body).innerHTML,o=document.createElement("div");o.innerHTML=t;const r={...e,extractedImages:e.saveImages?[]:void 0},n=window.html2org.convert(o.innerHTML,r);return{title:document.title,content:n,extractedImages:r.extractedImages||[],url:document.URL,author:document.querySelector('meta[name="author"]')?.getAttribute("content")||"",description:document.querySelector('meta[name="description"]')?.getAttribute("content")||""}}catch(e){return console.error("Error in content script:",e),null}},args:[{unorderedListMarker:c.ulBulletChar,orderedListMarker:c.olBulletChar,codeDelimiter:c.codeChar,listIndentSize:c.listIndentSize,codeBlockStyle:c.codeBlockStyle,decodeUri:c.decodeUri,squareBracketsInLink:c.squareBracketsInLink,ruby:c.rubyHandleMethod,saveImages:c.saveImages,imagePathPrefix:c.imagePathPrefix,imageSaveSubfolder:c.imageSaveSubfolder,extractedImages:[]}]});if(!t?.[0]?.result)throw new Error("Failed to get page content");const{title:o,content:r,url:n,author:a,description:i,extractedImages:s}=t[0].result;let l=`#+TITLE: ${o}\n`;l+=`#+DATE: ${(new Date).toISOString()}\n`,a&&(l+=`#+AUTHOR: ${a}\n`),l+=`#+SOURCE_URL: ${n}\n\n`,i&&(l+=`* Abstract\n\n${i}\n\n`),l+=`* Content\n\n${r}`;const d="data:text/org;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(l))),g=o.replace(/[<>:"/\\|?*]/g,"_").trim();if(await chrome.downloads.download({url:d,filename:`${g}.org`,saveAs:!0}),c.saveImages&&s&&s.length>0){const e=c.imageSaveSubfolder||"images";for(const t of s)try{const o=new URL(t.src,n).href;await chrome.downloads.download({url:o,filename:`${e}/${t.filename}`,saveAs:!1})}catch(e){console.error(`Failed to download image ${t.src}`,e)}}}catch(e){console.error("Failed to save page:",e),s("Error",`Failed to save page: ${e instanceof Error?e.message:"Unknown error"}`)}}(o)}catch(e){console.error("Failed to execute script:",e),s("Error",`Failed to process page content: ${e instanceof Error?e.message:"Unknown error"}`)}else if("save-page-as-org-folder"===e.menuItemId)try{await async function(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:["dist/content-script.js"]});const t=await chrome.scripting.executeScript({target:{tabId:e},func:e=>{try{const t=document.querySelector("article")||document.body,o=document.createElement("div");o.innerHTML=t.innerHTML;const r={...e,extractedImages:[]},n=window.html2org.convert(o.innerHTML,r);return{title:document.title,content:n,extractedImages:r.extractedImages||[],url:document.URL}}catch(e){return console.error("Error in content script:",e),null}},args:[{unorderedListMarker:c.ulBulletChar,orderedListMarker:c.olBulletChar,codeDelimiter:c.codeChar,listIndentSize:c.listIndentSize,codeBlockStyle:c.codeBlockStyle,decodeUri:c.decodeUri,squareBracketsInLink:c.squareBracketsInLink,ruby:c.rubyHandleMethod,saveImages:!0,imagePathPrefix:c.imagePathPrefix}]});if(!t?.[0]?.result)throw new Error("Failed to get page content");const o=t[0].result;console.log("[savePageAsOrgFolder] Extracted images:",o.extractedImages);const r=o.extractedImages.map((e=>{try{return new URL(e.src,o.url).href}catch(t){return e.src}}));let n=[];if(r.length>0){s("Processing",`Downloading ${r.length} images...`);const t=await chrome.scripting.executeScript({target:{tabId:e},func:async e=>window.html2org.fetchImagesAsBase64?await window.html2org.fetchImagesAsBase64(e):[],args:[r]});if(t?.[0]?.result){const e=t[0].result;console.log("[savePageAsOrgFolder] Fetched image data:",e),n=o.extractedImages.map(((t,o)=>({filename:t.filename,base64:e[o]?.base64||""}))).filter((e=>e.base64)),console.log("[savePageAsOrgFolder] Final image data with correct filenames:",n)}}const a=`save_folder_${Date.now()}`;await chrome.storage.local.set({[a]:{title:o.title,content:o.content,images:n}}),chrome.tabs.create({url:`dist/save_folder.html?id=${a}`})}catch(e){console.error("Failed to save page:",e),s("Error",`Failed to save page: ${e instanceof Error?e.message:"Unknown error"}`)}}(o)}catch(e){console.error("Failed to execute script:",e),s("Error",`Failed to process page content: ${e instanceof Error?e.message:"Unknown error"}`)}else if("copy-current-page-url-as-org-mode"===e.menuItemId)try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.url||!e.title)throw new Error("Cannot get page information");const t=`[[${e.url}][${e.title}]]`;await l(t,(e.url,e.title))}catch(e){console.error("Failed to copy page link:",e),s("Error",`Failed to copy page link: ${e instanceof Error?e.message:"Unknown error"}`)}else if("copy-selection-as-org-mode"===e.menuItemId)try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["dist/copy.js"]}),await chrome.scripting.executeScript({target:{tabId:t.id},func:()=>window.main()})}catch(e){console.error("Failed to copy selection:",e),s("Error",`Failed to copy selection: ${e instanceof Error?e.message:"Unknown error"}`)}else if("copy-link-as-org-mode"===e.menuItemId)try{await chrome.scripting.executeScript({target:{tabId:o},files:["dist/copy-link.js"]});const t=e;if(!t.linkText||!t.linkUrl)throw new TypeError("Missing link information");const r=t.linkText.replace(/([\\`*_[\]<>])/g,"\\$1");let n=t.linkUrl;console.log("Options ===>",c),c.decodeUri&&(n=function(e){try{return decodeURI(e)}catch(t){return console.error("[ERROR] decodeURI error",t),e}}(n)),l(`[[${n}][${r}]]`)}catch(e){console.error("Failed to process link:",e),s("Error",`Failed to copy link: ${e instanceof Error?e.message:"Unknown error"}`)}}else s("Error","Cannot execute script on this page")})),chrome.action.onClicked.addListener((e=>{console.log("[DEBUG] browserAction.onclicked",e),chrome.scripting.executeScript({target:{tabId:e.id??-1},files:["dist/copy.js"]})})),chrome.runtime.onMessage.addListener(((e,t,o)=>{const r=e;switch(r.type){case"showBgNotification":s(r.title,r.message);break;case"copyStringToClipboard":return console.log("listener: copy request",Date.now()),l(r.org,r.html).then((e=>{o({success:e})})),!0}}))})();